name: Release Image

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "RocketMQ Dashboard repo commit hash"
        required: false
        type: string
      force_release:
        description: "Force release even if not updated"
        required: false
        type: boolean
  schedule:
    - cron: "0 6 * * *"

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
  REGISTRY: registry.cn-shanghai.aliyuncs.com
  IMAGE_NAME: eastcoal-library/rocketmq-dashboard

permissions:
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dashboard repo
        uses: actions/checkout@v4
        with:
          repository: apache/rocketmq-dashboard
          ref: ${{ inputs.commit_sha || 'master' }}
      - id: resolve_dashboard_sha
        run: |
          commit_sha=$(git rev-parse HEAD)
          echo "result=$commit_sha" >> $GITHUB_OUTPUT

      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          token: ${{ env.GH_TOKEN }}
      - id: check_updated
        run: |
          current_sha=""
          latest_sha=${{ steps.resolve_dashboard_sha.outputs.result }}
          if [ -f ./hash ]; then
              current_sha=$(cat ./hash)
          fi
          if [ "$current_sha" == "$latest_sha" ]; then
              latest_sha=""
          else
              echo "$latest_sha" > ./hash
              dashboard_commit_msg=$(git log -1 --pretty=format:%B)
              git config --global user.email "github-actions[bot]@users.noreply.github.com"
              git config --global user.name "github-actions[bot]"
              git add .
              git commit -m "build from: $dashboard_commit_msg"
              git push
              cd ..
          fi
          echo "result=$latest_sha" >> $GITHUB_OUTPUT

      - name: Cancel if not changed
        uses: andymckay/cancel-action@0.4
        if: steps.check_updated.outputs.result == '' && !inputs.force_release

      - name: Set up JDK 8 for x64
        uses: actions/setup-java@v4
        with:
          java-version: "8"
          distribution: "temurin"
          architecture: x64
          cache: maven

      - name: Run the Maven package
        run: |
          mvn -q -DskipTests clean package

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rocketmq-dashboard.jar
          path: "**/*.jar"

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      # https://github.com/docker/login-action
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Resolve Image Tag
        id: resolve_image_tag
        run: |
          commit_sha="${{ inputs.commit_sha }}"
          tag="latest"
          if [ -n "$commit_sha" ]; then
            tag="${commit_sha:0:7}"
          fi
          echo "result=$tag" >> $GITHUB_OUTPUT

      # Build and push Docker image with Buildx (don't push on PR)
      # https://github.com/docker/build-push-action
      - name: Build and push Docker image
        uses: docker/build-push-action@0565240e2d4ab88bba5387d719585280857ece09
        with:
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.resolve_image_tag.outputs.result }}
